[scenario]
    id=20_Back_in_Town_Again
    next_scenario=21_Epilogue
    name=_"Back in Town. Again." # displayed scenario name
    map_data="{~add-ons/Revenge_of_the_Rogue/maps/20_Back_in_Town_Again.map}"
    {DEFAULT_SCHEDULE}
    turns=-1
    victory_when_enemies_defeated=no

    # Rogue reinforcements
    # Turn 5 Sini & Dark Elves
    # Turn 15 Mermen
    # Turn 25 Dwarven Doors folk and Gyphons
    # Turn 35 Wesnoth
    # Turn 45 Elves + Woses
    # Turn 50 Khalifate
    # Turn 55 Falcons
    

    # Northern reinforcements
    # Turn 10 - Dragons
    # Turn 20 - Saurians
    # Turn 30 - Skeletal Dragon
    # Turn 40 - Drakes
    



    [side]
        side=1
        controller="human"
	team_name=1 # used to determine which side is enemy or allied
	# wmllint: local spelling foo
	user_team_name= _ "Rogues" # visible to the user

	##:: Leader Info
	type=Rogue
	id=Edwin
	name=_"Edwin"
	gender=male
	canrecruit=yes
	unrenamable=true
        shroud=no
	##:: Gold and Income
	{GOLD 400 200 100}
	{INCOME 10 5 3}
        [unit]
            type=Longbowman
            side=1
            x=25
            y=12
            placement=map_passable
        [/unit]
        [unit]
            type=Longbowman
            side=1
            x=25
            y=19
            placement=map_passable
        [/unit]
        [unit]
            type=Longbowman
            side=1
            x=36
            y=12
            placement=map_passable
        [/unit]
        [unit]
            type=Longbowman
            side=1
            x=36
            y=17
            placement=map_passable
        [/unit]
        [unit]
            type=Spearman
            side=1
            x=27
            y=12
            placement=map_passable
        [/unit]
        [unit]
            type=Spearman
            side=1
            x=29
            y=12
            placement=map_passable
        [/unit]
        [unit]
            type=Spearman
            side=1
            x=33
            y=12
            placement=map_passable
        [/unit]
        [unit]
            type=Spearman
            side=1
            x=25
            y=16
            placement=map_passable
        [/unit]
        [unit]
            type=Spearman
            side=1
            x=31
            y=18
            placement=map_passable
        [/unit]
        [unit]
            type=Spearman
            side=1
            x=33
            y=18
            placement=map_passable
        [/unit]
        [unit]
            type=Spearman
            side=1
            x=27
            y=19
            placement=map_passable
        [/unit]
        [unit]
            type=Peasant
            side=1
            x=25
            y=13
            placement=map_passable
        [/unit]
        [unit]
            type=Peasant
            side=1
            x=31
            y=12
            placement=map_passable
        [/unit]
        [unit]
            type=Peasant
            side=1
            x=36
            y=13
            placement=map_passable
        [/unit]
        [unit]
            type=Peasant
            side=1
            x=36
            y=15
            placement=map_passable
        [/unit]
        [unit]
            type=Peasant
            side=1
            x=35
            y=18
            placement=map_passable
        [/unit]
        [unit]
            type=Peasant
            side=1
            x=29
            y=18
            placement=map_passable
        [/unit]
        [unit]
            type=Peasant
            side=1
            x=26
            y=18
            placement=map_passable
        [/unit]
        [unit]
            type=Javelineer
            side=1
            x=25
            y=14
            placement=map_passable
        [/unit]
        [unit]
            type=Javelineer
            side=1
            x=28
            y=18
            placement=map_passable
        [/unit]
        [unit]
            type=Pikeman
            side=1
            x=36
            y=14
            placement=map_passable
        [/unit]
        [unit]
            type=Pikeman
            side=1
            x=26
            y=12
            placement=map_passable
        [/unit]
        [unit]
            type=Swordsman
            side=1
            x=30
            y=12
            placement=map_passable
        [/unit]
        [unit]
            type=Swordsman
            side=1
            x=32
            y=12
            placement=map_passable
        [/unit]
        [unit]
            type=Trapper
            side=1
            x=25
            y=15
            placement=map_passable
        [/unit]

        [unit]
            type=Poacher
            side=1
            x=25
            y=17
            placement=map_passable
        [/unit]
        [unit]
            type=Thug
            side=1
            x=36
            y=16
            placement=map_passable
        [/unit]
        [village]
            x=28
            y=13
        [/village]
        [village]
            x=34
            y=13
        [/village]
        [village]
            x=28
            y=16
        [/village]
        [village]
            x=34
            y=16
        [/village]
        [village]
            x=25
            y=9
        [/village]
        [village]
            x=19
            y=16
        [/village]
        [village]
            x=41
            y=14
        [/village]
        [village]
            x=41
            y=21
        [/village]
        [village]
            x=25
            y=9
        [/village]
        [village]
            x=22
            y=23
        [/village]
        [village]
            x=47
            y=12
        [/village]
        [village]
            x=18
            y=3
        [/village]
        [village]
            x=15
            y=7
        [/village]
        [village]
            x=19
            y=7
        [/village]
        [village]
            x=23
            y=1
        [/village]
        [village]
            x=29
            y=5
        [/village]
    [/side]

    [side]
	##:: Side Info
	side=2
	controller=ai
	team_name=2
	user_team_name= _ "Northerners"

	##:: Leader Info
	type=Lich
	id=Valda
	name=_"Valda"
        gender=female
	canrecruit=yes
	unrenamable=true

	##:: Recruit List
	recruit=Dark Adept,Ghost,Orcish Archer,Orcish Grunt,Wolf Rider,Goblin Spearman,Orcish Assassin,Troll Whelp,Vampire Bat,Skeleton,Skeleton Archer,Young Ogre,Black Mage,Ghoul,Walking Corpse,Orcish Crossbowman,Orcish Warrior
	##:: Gold and Income

	{GOLD 50 100 200}
	{INCOME 3 5 10}
        [unit]
            type=Dark Adept
            gender=female
            side=2
            x=53
            y=2
            [status]
                guardian=yes
            [/status]
        [/unit]
        [unit]
            type=Dark Adept
            gender=female
            side=2
            x=55
            y=2
            [status]
                guardian=yes
            [/status]
        [/unit]
    [/side]

    [side]
	##:: Side Info
	side=3
	controller=ai
	team_name=2
	user_team_name= _ "Northerners"

	##:: Leader Info
	type="Death Knight"
	id=Than Mot
	name=_"Than Mot"
	canrecruit=yes
	unrenamable=true
        recruit=Skeleton,Skeleton Archer,Ghost,Ghoul,Walking Corpse
	{GOLD 100 200 300}
	{INCOME 3 5 10}

        [unit]
            type=Chocobone
            side=3
            x=27
            y=11
        [/unit]
        [unit]
            type=Shadow
            side=3
            x=30
            y=11
        [/unit]
        [unit]
            type=Nightgaunt
            side=3
            x=34
            y=11
        [/unit]
        [unit]
            type=Wraith
            side=3
            x=35
            y=12
        [/unit]
        [unit]
            type=Spectre
            side=3
            x=37
            y=14
        [/unit]
        [unit]
            type=Necrophage
            side=3
            x=27
            y=20
        [/unit]
        [unit]
            type=Ghast
            side=3
            x=25
            y=20
        [/unit]
        [unit]
            type=Deathblade
            side=3
            x=24
            y=19
        [/unit]
        [unit]
            type=Revenant
            side=3
            x=38
            y=17
        [/unit]
        [unit]
            type=Draug
            side=3
            x=31
            y=10
        [/unit]
        [unit]
            type=Bone Shooter
            side=3
            x=26
            y=10
        [/unit]
        [unit]
            type=Banebow
            side=3
            x=38
            y=17
        [/unit]
        [unit]
            type=Skeleton
            side=3
            x=29
            y=11
        [/unit]
        [unit]
            type=Skeleton
            side=3
            x=31
            y=11
        [/unit]
        [unit]
            type=Skeleton
            side=3
            x=33
            y=11
        [/unit]
        [unit]
            type=Skeleton
            side=3
            x=36
            y=11
        [/unit]
        [unit]
            type=Skeleton
            side=3
            x=31
            y=19
        [/unit]
    [/side]

    [side]
	##:: Side Info
	side=4
	controller=ai
	team_name=2
	user_team_name= _ "Northerners"

	##:: Leader Info
	type="Orcish Sovereign"
	id=Regzdur
	name=_"Regzdur"
	canrecruit=yes
	unrenamable=true
        recruit=Orcish Archer,Orcish Grunt,Wolf Rider,Goblin Spearman,Orcish Assassin,Troll Whelp
	{GOLD 150 200 250}
	{INCOME 3 5 10}
        [unit]
            type=Orcish Warrior
            side=4
            x=24
            y=10
        [/unit]
        [unit]
            type=Orcish Warrior
            side=4
            x=23
            y=15
        [/unit]
        [unit]
            type=Orcish Warrior
            side=4
            x=22
            y=17
        [/unit]
        [unit]
            type=Orcish Warrior
            side=4
            x=23
            y=15
        [/unit]
        [unit]
            type=Orcish Warrior
            side=4
            x=25
            y=21
        [/unit]
        [unit]
            type=Orcish Warrior
            side=4
            x=28
            y=20
        [/unit]
        [unit]
            type=Orcish Warrior
            side=4
            x=30
            y=19
        [/unit]
        [unit]
            type=Orcish Warrior
            side=4
            x=34
            y=19
        [/unit]
        [unit]
            type=Orcish Warrior
            side=4
            x=38
            y=18
        [/unit]
        [unit]
            type=Orcish Warrior
            side=4
            x=38
            y=16
        [/unit]
        [unit]
            type=Orcish Warrior
            side=4
            x=38
            y=13
        [/unit]
        [unit]
            type=Orcish Slayer
            side=4
            x=22
            y=12
        [/unit]
        [unit]
            type=Orcish Slayer
            side=4
            x=28
            y=10
        [/unit]
        [unit]
            type=Orcish Slayer
            side=4
            x=38
            y=14
        [/unit]
        [unit]
            type=Orcish Slayer
            side=4
            x=36
            y=19
        [/unit]
        [unit]
            type=Orcish Slayer
            side=4
            x=29
            y=19
        [/unit]
        [unit]
            type=Orcish Crossbowman
            side=4
            x=33
            y=20
        [/unit]
        [unit]
            type=Orcish Crossbowman
            side=4
            x=23
            y=14
        [/unit]
        [unit]
            type=Orcish Crossbowman
            side=4
            x=29
            y=20
        [/unit]
        [unit]
            type=Orcish Crossbowman
            side=4
            x=37
            y=19
        [/unit]
        [unit]
            type=Orcish Crossbowman
            side=4
            x=38
            y=15
        [/unit]
        [unit]
            type=Orcish Crossbowman
            side=4
            x=37
            y=12
        [/unit]
        [unit]
            type=Orcish Crossbowman
            side=4
            x=30
            y=10
        [/unit]
        [unit]
            type=Goblin Rouser
            side=4
            x=24
            y=16
        [/unit]
        [unit]
            type=Goblin Impaler
            side=4
            x=24
            y=17
        [/unit]
        [unit]
            type=Goblin Impaler
            side=4
            x=24
            y=15
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=24
            y=13
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=24
            y=12
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=26
            y=19
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=28
            y=19
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=30
            y=18
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=32
            y=18
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=34
            y=18
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=36
            y=18
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=37
            y=18
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=37
            y=17
        [/unit]
        [unit]
            type=Goblin Spearman
            side=4
            x=37
            y=16
        [/unit]
        [unit]
            type=Great Troll
            side=4
            x=37
            y=13
        [/unit]
        [unit]
            type=Troll Warrior
            side=4
            x=24
            y=14
        [/unit]
        [unit]
            type=Troll Hero
            side=4
            x=24
            y=18
        [/unit]
        [unit]
            type=Troll Shaman
            side=4
            x=28
            y=11
        [/unit]
        [unit]
            type=Troll Rocklobber
            side=4
            x=32
            y=11
        [/unit]
        [unit]
            type=Troll Rocklobber
            side=4
            x=38
            y=19
        [/unit]
        [unit]
            type=Troll Rocklobber
            side=4
            x=36
            y=10
        [/unit]
        [unit]
            type=Troll
            side=4
            x=29
            y=10
        [/unit]
        [unit]
            type=Troll
            side=4
            x=22
            y=15
        [/unit]
        [unit]
            type=Troll
            side=4
            x=34
            y=20
        [/unit]
        [unit]
            type=Troll Whelp
            side=4
            x=33
            y=21
        [/unit]
        [unit]
            type=Troll Whelp
            side=4
            x=35
            y=19
        [/unit]
        [unit]
            type=Troll Whelp
            side=4
            x=24
            y=11
        [/unit]
        [unit]
            type=Troll Whelp
            side=4
            x=26
            y=11
        [/unit]
        [unit]
            type=Troll Whelp
            side=4
            x=33
            y=19
        [/unit]






    [/side]

    [event]
	name=prestart
        [set_variable]
            name=edwin_life_state
            value=1
        [/set_variable]
        [set_variable]
            name=sini_life_state
            value=1
        [/set_variable]
        
        [store_unit]
            kill=yes
            variable=Elf_Recalls
            [filter]
                side=1
                x,y=recall,recall
                race=dark elf
            [/filter]
        [/store_unit]

        [store_unit]
            kill=yes
            variable=sini_storage
            [filter]
                id=Sini
            [/filter]
        [/store_unit]

        [recall]
            id=Karduras
        [/recall]
        {RECALL_LOYAL}
        {RECALL_TWELVE}
        [unstore_unit]
            variable=vikki_store
            x=31
            y=13
        [/unstore_unit]
        [set_recruit]
            side=1
            recruit=Ruffian,Woodsman,Thief,Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Ulfserker,Dwarvish Guardsman,Dwarvish Scout,Elvish Shaman
        [/set_recruit]
        [recall]
            side=1
        [/recall]


    [/event]
    [event]
        name=last breath
        first_time_only=no
        [filter]
            id=Sini
        [/filter]
        [if]
            [variable]
                name=sini_life_state
                equals=3
            [/variable]
                [then]
                    [if]
                        [variable]
                            name=edwin_life_state
                            equals=3
                        [/variable]
                        [then]
                            [message]
		                speaker=Sini
		                message=_"Edwin, my spirit is becoming one with you in the Spirit of the forest."
	                    [/message]
                            [endlevel]
                                result=defeat
                            [/endlevel]
                        [/then]
                        [else]
                            [message]
		                speaker=Sini
		                message=_"I do not fear death, my spirit is becoming one with the Spirit of the forest."
	                    [/message]
                            [set_variable]
                                name=sini_life_state
                                value=4
                            [/set_variable]
                            [message]
		                speaker=Edwin
		                message=_"Noooo, we will avenge your death my sweet lady druid."
	                    [/message]

                        [/else]
                    [/if]
                [/then]
            [/if]

            [if]
                [variable]
                    name=sini_life_state
                    equals=2
                [/variable]
                [then]
                    [if]
                        [variable]
                            name=edwin_life_state
                            equals=2
                        [/variable]
                        [then]
                            [message]
		                speaker=Sini
		                message=_"Edwin I am sorry I couldn't help you reclaim your home."
	                    [/message]
                            [message]
		                speaker=Edwin
		                message=_"Call on the spirit of the forest."
	                    [/message]
                            [message]
		                speaker=Sini
		                message=_"Now I have seen what happened to you, I am not sure I can do it to myself."
	                    [/message]
                            [message]
		                speaker=Edwin
		                message=_"It grows on you. Anyway you made a promise."
	                    [/message]
                            [message]
		                speaker=Sini
		                message=_"Okay, okay, bossy roots."
	                    [/message]
                        [/then]
                    [/if]


                    [if]
                        [variable]
                            name=edwin_life_state
                            equals=1
                        [/variable]
                        [then]
                            [message]
		                speaker=Sini
		                message=_"Edwin, I am going to be different, please don't look at me."
	                    [/message]
                        [/then]
                    [/if]


	            [message]
		        speaker=Sini
		        message=_"Spirit who created the trees and all creatures, fill me now and give me life."
	            [/message]
                    {TRANSFORM_UNIT id=Sini Wose}
                    {FULL_HEAL id=Sini}
                    [set_variable]
                        name=sini_life_state
                        value=3
                    [/set_variable]


                    [if]
                        [variable]
                            name=edwin_life_state
                            equals=1
                        [/variable]
                        [then]
                            [message]
		                speaker=Edwin
		                message=_"You are still beautiful, just in a more leafy kind of way, can hardly notice the difference."
	                    [/message]
                            [message]
		                speaker=Sini
		                message=_"Thanks, I was worried I would be ugly."
	                    [/message]
                            [message]
		                speaker=Edwin
		                message=_"Let us focus on the goblins, okay?"
	                    [/message]
                        [/then]
                    [/if]
                [/then]
            [/if]

            [if]
                [variable]
                    name=sini_life_state
                    equals=1
                [/variable]
                [then]
                    [message]
		        speaker=Sini
		        message=_"You cannot defeat me, little goblins, the magic of the holy forest is too strong."
	            [/message]
                    {FULL_HEAL id=Sini}
                    [set_variable]
                        name=sini_life_state
                        value=2
                    [/set_variable]
                [/then]
            [/if]

	[/event]



	[event]
            name=last breath
            first_time_only=no
            [filter]
                id=Edwin
            [/filter]
            [if]
                [variable]
                    name=sini_life_state
                    less_than=3
                [/variable]
                [then]
                    [if]
                        [variable]
                            name=edwin_life_state
                            equals=2
                        [/variable]
                        [then]
                            [message]
		                speaker=Edwin
		                message=_"Argh, I am fallen."
	                    [/message]
                            [message]
		                speaker=Sini
		                message=_"Even I cannot save you this time Edwin. Your spirit is now part of the forest and the dead wood from your body will become a source of life to many creatures."
	                    [/message]
                            [message]
		                speaker=Edwin
		                message=_"You Sini must lead my people, lead my people home..."
	                    [/message]
                            [message]
		                speaker=Sini
		                message=_"I will try and if I fail my spirit will join yours in the forest. So long Edwin."
	                    [/message]
                            [set_variable]
                                name=edwin_life_state
                                value=3
                            [/set_variable]
                            [modify_unit]
                                [filter]
                                    id=Sini
                                [/filter]
                                canrecruit=yes
                            [/modify_unit]
	                    [objectives]
		                side=1
		                [objective]
		                    description= _ "Defeat the enemy leader"
		                    condition=win
		                [/objective]
		                [objective]
		                    description= _ "Death of Sini"
		                    condition=lose
		                [/objective]
		                {TURNS_RUN_OUT}
		                [gold_carryover]
		                    bonus=yes
		                    carryover_percentage=40
		                [/gold_carryover]
	                    [/objectives]
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=edwin_life_state
                            equals=1
                        [/variable]
                        [then]
	                    [message]
		                speaker=Edwin
		                message=_"I am fallen. I knew the risks and do not fear death, but I failed to lead my people home."
	                    [/message]
	                    [message]
		                speaker=Sini
		                message=_"Goodbye Edwin, sadly you are beyond saving ... at least according to the conventional healing arts. Well if my past work is any guide, we stand a chance."
	                    [/message]
	                    [message]
		                speaker=Edwin
		                message=_"I would consent to any of your druidic experiments, if it means I live long enough to lead my people."
	                    [/message]
	                    [message]
		                speaker=Sini
		                message=_"You should know the process may change you... somewhat."
	                    [/message]
	                    [message]
		                speaker=Edwin
		                message=_"Will it weaken me?"
	                    [/message]
                            [message]
		                speaker=Sini
		                message=_"No no. You shall become more powerful than you could possibly imagine."
	                    [/message]
	                    [message]
		                speaker=Edwin
		                message=_"Very well."
	                    [/message]
	                    [message]
		                speaker=Sini
		                message=_"Spirit who created the trees and all creatures, fill Edwin now and give him life."
	                    [/message]
                            [set_variable]
                                name=edwin_life_state
                                value=2
                            [/set_variable]
                            {TRANSFORM_UNIT id=Edwin Wose}
                            {FULL_HEAL id=Edwin}
	                    [message]
		                speaker=Edwin
		                message=_"You were right when you said I could not imagine this. However, I will lead my people home in this new form. Thank you Sini."
	                    [/message]
                            [message]
		                speaker=Sini
		                message=_"Thank the Spirit, not me. I personally think you have never looked more beautiful. However, there is a price to be paid. When you lead your people to their home, it will not be your home. The forest is now your home. Unless some greater magic can restore your original form."
	                    [/message]
	                    [message]
		                speaker=Edwin
		                message=_"I already feel drawn to the forest, it feels as natural as falling asleep. However, I also now feel the presence of evil in this forest and it must be removed. So now let us try again to clear out these goblins."
	                    [/message]
                        [/then]
                    [/if]
                [/then]
                [else]
                    [message]
		        speaker=Edwin
		        message=_"Noooo ... sorry my people, I have failed you."
	            [/message]
                [/else]
            [/if]
                    

        [/event]



[/scenario]